# Cloudflare R2 & Vectorize Setup

## Prerequisites

Set these environment variables:

```bash
export CLOUDFLARE_ACCOUNT_ID=your-32-char-hex-account-id
export CLOUDFLARE_EMAIL=your-cloudflare-email@example.com
export CLOUDFLARE_GLOBAL_API_KEY=your-global-api-key
```

**Finding credentials:**
- **Account ID**: Found in Cloudflare dashboard URL or R2 Overview page (32 hex characters)
- **Email**: Your Cloudflare account email
- **Global API Key**: [My Profile > API Tokens](https://dash.cloudflare.com/profile/api-tokens) > Global API Key > View

## Unified Configuration

The R2 setup now automatically configures both R2 storage and Vectorize embeddings with a single unified API token that works for both services.

### Interactive Setup (Recommended)

```bash
npm run as -- config configure --service r2
```

This will:
- Test your Cloudflare credentials
- Create a unified API token with R2 and Vectorize permissions
- Test both R2 storage and Vectorize API access
- Save all credentials to your `.env` file
- Set up default buckets and verify functionality

### Manual Environment Setup

If you prefer manual setup, add these to your `.env` file:

```bash
CLOUDFLARE_ACCOUNT_ID=your-32-char-hex-account-id
CLOUDFLARE_EMAIL=your-cloudflare-email@example.com
CLOUDFLARE_GLOBAL_API_KEY=your-global-api-key
CLOUDFLARE_API_TOKEN=your-unified-api-token
```

## Usage

### Basic Upload
```bash
npm run as -- text --video "https://www.youtube.com/watch?v=MORMZXEaONk" \
  --whisper large-v3-turbo \
  --chatgpt gpt-4o-mini \
  --save r2
```

### Custom Bucket Prefix
```bash
npm run as -- text --rss "https://ajcwebdev.substack.com/feed" \
  --last 3 \
  --save r2 \
  --s3-bucket-prefix "my-r2-content"
```

### Batch Processing
```bash
npm run as -- text --playlist "https://www.youtube.com/playlist?list=PLCVnrVv4KhXPz0SoAVu8Rc1emAdGPbSbr" \
  --deepgram nova-2 \
  --claude claude-3-5-haiku-latest \
  --save r2
```

## Vectorize Embeddings

With the unified setup, you can immediately use Vectorize embeddings:

### Create Embeddings
```bash
# Create embeddings from processed content
npm run as -- text embed --create "content"
```

### Query Embeddings
```bash
# Search your knowledge base
npm run as -- text embed --query "What are the main themes discussed?"
```

## R2 Features

- **Zero egress fees**: No charges for downloading files
- **S3-compatible API**: Works with existing S3 tools
- **Global distribution**: Automatic edge caching via Cloudflare network
- **Integrated Vectorize**: Seamless embedding storage and retrieval
- **Unified token management**: Single API token for both services

## Verification

Check your configuration status:

```bash
npm run as -- config
```

This will show the status of both R2 storage and Vectorize functionality.